<script>
  var referrer_path = document.referrer;
  var current_path = window.location.href;
  if (Shopify.Checkout.step === 'shipping_method' && referrer_path.includes('/cart')) { 
    window.location.href = current_path + '?previous_step=contact_information&step=shipping_method&past=1';
  } else if (Shopify.Checkout.step === 'shipping_method' && !referrer_path.includes("?") && !current_path.includes('past')){
    window.location.href = 'https://' + window.location.hostname + window.location.pathname;
  }
</script>

<script>
  (function(a,s,y,n,c,h,i,d,e){s.className+=' '+y;h.start=1*new Date;
  h.end=i=function(){s.className=s.className.replace(RegExp(' ?'+y),'')};
  (a[n]=a[n]||[]).hide=h;setTimeout(function(){i();h.end=null},c);h.timeout=c;
  })(window,document.documentElement,'async-hide','dataLayer',4000,
  {'GTM-WQC382F':true});
</script>

<!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WQC382F');
</script>
<!-- End Google Tag Manager -->

{% render 'dataLayer-allPages' %}

{% comment %} <script>
  if (Shopify.Checkout.step === 'thank_you') {
    var enhanced_conversion_data = {
      "email": "{{ checkout.email }}",
      "phone_number": "{{ checkout.shipping_address.phone }}",
      "first_name": "{{ checkout.shipping_address.first_name }}",
      "last_name": "{{ checkout.shipping_address.last_name }}",
      "home_address": {
        "street": "{{ checkout.shipping_address.address1 }}",
        "city": "{{ checkout.shipping_address.city }}",
        "region": "{{ checkout.shipping_address.province }}",
        "postal_code": "{{ checkout.shipping_address.zip }}",
        "country": "{{ checkout.shipping_address.country }}"
      }
    };
    window.dataLayer.push({
      "conversion_value": {{ checkout.total_price | money_without_currency | replace: ",", "" }},
      "transaction_id": "{{ checkout.order_id }}"
    });
  }
</script> {% endcomment %}

<!-- KLAVIYO Tracking-->
<script>
  var _learnq = _learnq || [];
  _learnq.push(['account', 'L8urMJ']);
  (function () {
  var b = document.createElement('script'); b.type = 'text/javascript'; b.async = true;
  b.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'a.klaviyo.com/media/js/analytics/analytics.js';
  var a = document.getElementsByTagName('script')[0]; a.parentNode.insertBefore(b, a);
  })();
  (function($) {
    $(document).on('page:load page:change', function() {
      $('#checkout_email').on('blur', function() {
        var k_email = $(this).val();
        _learnq.push(['identify', {$email: k_email}]);
      });
    });
  })(Checkout.$);
</script>

{% comment %}  calculate cart item quantities.  {% endcomment %}
{% assign total_item_count = 0 %}
{% for item in checkout.line_items %}
  {% assign item_quantity = item.quantity | times: 1 %}
  {% assign total_item_count = total_item_count | plus: item_quantity %}
{% endfor %}
<script>
  (function($) {
    {% comment %} 
    function capi(purchase_variant_ids) {
      var myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");

      var raw = JSON.stringify({
        "event_name": "Purchase",
        "event_time": 0,
        "event_source_url": window.location.href,
        "user_data_em": "{{ checkout.email | sha256 }}",
        "user_data_ph": "{{ checkout.billing_address.phone | sha256 }}",
        "user_data_client_user_agent": navigator.userAgent,
        "user_data_client_ip_address": sessionStorage.getItem('ip_address'),
        "custom_data_value": {{ checkout.line_items_subtotal_price | money_without_currency | replace: ",", "" }},
        "custom_data_currency": "USD",
        "custom_data_content_ids": purchase_variant_ids,
        "custom_data_content_ids_num": {{ total_item_count }},
        "custom_data_content_type": "product",
        "fbp": window.localStorage.getItem('fb_capi_fbp'),
        "fbc": window.localStorage.getItem('fb_capi_fbc'),
        "opt_out": false,
        "test_event_code": ""
      });

      var requestOptions = { method: 'POST', headers: myHeaders, body: raw, redirect: 'follow' };
      fetch("https://fgq0quzxr6.execute-api.us-east-2.amazonaws.com/v1/capi/efmt", requestOptions)
        .then(response => response.json())
        .then(result => console.log(''))
        .catch(error => console.log('error', error));
    }
    
    var purchase_item_ids = purchase_item_ids || [];
    var purchase_variant_ids = purchase_variant_ids || [];
    $('.product').each(function() {
      purchase_item_ids.push( { 'id':$(this).data('variant-id'), 'google_business_vertical':'retail' } );
      purchase_variant_ids.push( $(this).data('variant-id') );
    });
    {% endcomment %}
    {% comment %}
    if(Shopify.Checkout.step =='thank_you') {
       window.dataLayer.push({ 
        'conversion_value': {{ checkout.total_price | money_without_currency | replace: ",", "" }},
        'transaction_id': '{{ checkout.order_id }}'
      });
      window.dataLayer.push({
        'event': 'purchase',
        'get_value': {{ checkout.total_price | money_without_currency | replace: ",", "" }},
        'items': purchase_item_ids
      });
      
      walter update 2022/07/06 ::::: DO NOT REMOVE THIS SECTION
      window.dataLayer.push({ 
        'fb_capi': {
          'cus_ip': sessionStorage.getItem('ip_address'),
          'cus_tel' : '{{checkout.billing_address.phone | sha256 }}',
          'cus_eml' : '{{checkout.email | sha256 }}',
          'cus_url' : window.location.href,
          'cus_value' : {{ checkout.total_price | money_without_currency | replace: ",", "" }},
          'cus_agent' : navigator.userAgent
        }
      });
      capi(purchase_variant_ids); 
      
      
    } else {
       window.dataLayer.push({
        'event': 'add_to_cart',
        'get_value': {{ checkout.total_price | money_without_currency | replace: ",", "" }},
        'items': purchase_item_ids
      }); 
    }

    if (Shopify.Checkout.step =='payment_method') {
      $.getJSON('https://jsonip.com/?callback=?').done(function(data) {
        var ip_address = window.JSON.parse(JSON.stringify(data, null, 2));
        ip_address = ip_address.ip;
        sessionStorage.setItem('ip_address', ip_address);
      });
    }
    {% endcomment %}

    {% comment %}  w added cart and checkout tracking --------Start {% endcomment %}
    var lineitem_obj = [], item_count = 0 , noneID, CartSession , tracker_obj = [] ;
    if(!localStorage.getItem('noneID') && (typeof( localStorage.getItem('noneID')) !== 'undefined')){ 
      noneID = 'EF-' + Math.random().toString(36).replace(/[^a-z1-9]+/g, '').substr(0, 8) + '-' + Math.random().toString(36).replace(/[^a-z1-9]+/g, '').substr(0, 6); 
      localStorage.setItem('noneID', noneID); 
    } else { 
      noneID = localStorage.getItem('noneID'); 
    }
    if(!localStorage.getItem('CartSession') && (typeof( localStorage.getItem('CartSession')) !== 'undefined')) { 
      CartSession = 'CS-' + Math.random().toString(36).replace(/[^a-z1-9]+/g, '').substr(0, 10); 
      localStorage.setItem('CartSession', CartSession); 
    } else { 
      CartSession = localStorage.getItem('CartSession'); 
    }

    {% for item in checkout.line_items %}
      lineitem_obj.push({ 
        "quantity": "{{ item.quantity }}", 
        "variant_id": "{{ item.variant_id }}", 
        "price": "{{ item.price }}", 
        "original_price": "{{ item.original_price }}", 
        "discounted_price": "{{ item.discounted_price }}", 
        "line_price": "{{ item.line_price }}", 
        "sku": "{{ item.sku }}", 
        "vendor": "{{ item.vendor }}", 
        "product_id": "{{ item.product_id }}", 
        "final_price": "{{ item.final_price }}", 
        "final_line_price": "{{ item.final_line_price }}", 
        "product_title": "{{ item.title }}"
      });
      item_count += {{ item.quantity }};
    {% endfor %}

    tracker_obj = {
      "body":{
        "cartinfo" : {
          "original_total_price": {{ checkout.line_items_subtotal_price }},
          "total_price": {{ checkout.total_price }},
          "total_discount": {{ checkout.discounts_amount }},
          "item_count":item_count,
          "items_subtotal_price": {{ checkout.line_items_subtotal_price }},
          "items": lineitem_obj,
          "nid": noneID,
          "cs": CartSession,
          "cid": __st["cid"],
          "ts": {{ 'now' | date: "%s"}},
          "op": Shopify.Checkout.step,
          "ip": sessionStorage.getItem('ip_address')
        }
      }
    }
      
    function tw_c_tracker(tracker_obj) {
      //console.log(tracker_obj);
      if (Shopify.Checkout.step === "thank_you") {
        window.localStorage.removeItem("CartSession");
        // console.log('remove');
        // console.log(localStorage.getItem('CartSession'));
      }
      var myHeaders = new Headers();
      myHeaders.append("Content-Type", "application/json");
      var raw = JSON.stringify(tracker_obj);
      //var tracker_obj = JSON.stringify(tracker_obj)
      //console.log(raw)
      var requestOptions = { method: 'POST', headers: myHeaders, body: raw, redirect: 'follow' };
      fetch("https://tracker.efmt.app/v1/behavior-tracking", requestOptions)
        .then(response => response.json())
        .then(result => console.log(''))
        .catch(error => console.log('error', error));
    }

    tw_c_tracker(tracker_obj);

    {% comment %}  w added cart and checkout tracking --------End  {% endcomment %}
  })(Checkout.$);
</script>

<script>
  (function($) {
    function setCookie(name, value, days = 1) {
      var date = new Date();
      date.setTime(date.getTime()+(days * 24 * 60 * 60 * 1000));
      var expires = "; expires="+date.toUTCString();
      document.cookie = name + "=" + value + expires + "; path=/";
    }
    function getCookie(name) {
      var value = `; ${document.cookie}`;
      var parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    $(window).on("load", function() {
      if(Shopify.Checkout.step === 'thank_you') {
        var purchase_product_ids = JSON.parse(getCookie('purchase_product_ids') || '[]');
        $('.product').each(function() {
          var product_id = $(this).data('product-id');
          if (!purchase_product_ids.includes(product_id)) {
            purchase_product_ids.push($(this).data('product-id'));
            if (purchase_product_ids.length > 10) {
              purchase_product_ids = purchase_product_ids.slice(Math.max(purchase_product_ids.length - 10, 0));
            }
          }
        });
        setCookie('purchase_product_ids', JSON.stringify(purchase_product_ids), 30);
      }
    });
    $(document).on('page:load page:change', () => {
      const { step } = Shopify.Checkout;
      const cbbData = localStorage.getItem('cbb-shipping-rates-calculator-shipping-rate-object');
      // console.log('step', step);
      // console.log('cbbData', cbbData);
      if (cbbData && step === 'shipping_method') {
        const { id, amount } = JSON.parse(cbbData).value;
        const $target = $(`.content-box[data-shipping-methods] .radio-wrapper:eq(${id.split('-').pop()})`);
        const value = $target.attr('data-shipping-method').split('-').pop();
        if (amount === value) $target.find('input.input-radio').prop('checked', true);
      }
    });
  })(Checkout.$);
</script>