{%- comment -%}
------- Swatch -----------
{%- endcomment -%}
{%- liquid
  assign pos360 = ''
  assign optVr1 = ''
  assign imgsPos = ''
  assign imgsPos0 = 0
  assign imgsPos1 = 0
  
  assign gallery_opt = 0
  assign gallery_opt_ = 'option1'
  if product.tags contains 'gll_otp2'
    assign gallery_opt = 1
    assign gallery_opt_ = 'option2'
  endif
  if product.tags contains 'gll_otp3'
    assign gallery_opt = 2
    assign gallery_opt_ = 'option3'
  endif
  assign variants = product.variants
  assign offset = 0
  for value in product.options_with_values[gallery_opt].values
    assign variants_by_option = variants | where: gallery_opt_, value
    for media in product.media offset: offset
      if media.preview_image.src == variants_by_option.first.featured_image.src
        if imgsPos == ''
          assign imgsPos =  media.position | append: ","| split: ','
        else
          assign imgsPos = imgsPos | join: ',' | append: ","  | append: media.position | split: ','
        endif
        assign offset = media.position | minus: 1
        break
      endif
    endfor
  endfor

  assign imgsPosCheckLast = imgsPos
  for media in product.media
    if media.alt == 'kt_360'
      assign pos360 = forloop.index | append: "," | append: product.media.size | split: ','
    endif
  endfor
  if pos360 != ''
    assign lastPos = "," | append: pos360[0]
  elsif product.media.size == 1
    assign lastPos = "," | append: 2
  else
    assign lastPos = "," | append: product.media.size
  endif
  if imgsPos == ''
    assign imgsPos = '1' | append: lastPos | split: ','
  else
    if settings.gallery == false
      assign imgsPos = '1' | append: lastPos | split: ','
    else
      assign imgsPos = imgsPos | join: ',' | append: lastPos | split: ','
    endif
  endif
  assign imgsPos0 = imgsPos[0] | plus:0
  assign imgsPos1 = imgsPos[1] | plus:0
  if imgsPos0 >= imgsPos1
    assign imgsPos = '1' | append: lastPos | split: ','
    assign imgsPos0 = imgsPos[0] | plus:0
    assign imgsPos1 = imgsPos[1] | plus:0
  endif

  assign imgPos = product.selected_or_first_available_variant.featured_media.position | default: 1

  for imgspr in imgsPos
    assign idx = forloop.index
    assign idx_ = forloop.index | minus: 2
    assign imgsPos0Int = imgspr | plus: 0
    assign imgsPos1Int = imgsPos[idx] | plus: 0
    if imgsPos0Int <= imgPos and imgPos < imgsPos1Int or imgsPos0Int > imgPos and imgPos < imgsPos1Int
      assign imgsPos0 = imgsPos0Int
      assign imgsPos1 = imgsPos1Int
      break
    endif
    assign imgsPosLast = imgsPos.last | plus:0
    if imgsPos0Int == imgsPosLast
      if imgsPosCheckLast contains imgsPos.last
        assign imgsPos0 = imgsPosLast
        assign imgsPos1 = imgsPosLast
      else
        assign imgsPos0 = imgsPos[idx_] | plus:0
        assign imgsPos1 = imgsPosLast
        assign vrimgpos = imgsPos1
      endif
    endif
  endfor
-%}
{%- comment -%}
------- Check one image -----------
{%- endcomment -%}
{%- liquid
  assign checkOneImage = imgsPos0 | plus: 1
  assign checkOneImage_ = false
  if product.media.size == 1
    assign checkOneImage_ = true
  endif

  assign settings_gallery = settings.gallery
  if settings_gallery
    if checkOneImage == imgsPos1 and checkOneImage != product.media.size
      assign checkOneImage_ = true
    endif
    if checkOneImage > product.media.size
      assign checkOneImage_ = true
    endif
    assign imgsPos1- = imgsPos1 | minus: 1
    if imgsPos0 == imgsPos1- and checkOneImage != product.media.size
      assign checkOneImage_ = true
    endif
  endif
-%}
{%- if template.suffix == 'prd-additional' -%}
<!-- unique_tabs -->
  {%-for block in section.blocks-%}
    {%-if block.type == "tb_unique"-%}
    {{-block.settings|json-}}|
    {%-endif-%}
  {%-endfor-%}
<!-- end_unique_tabs -->
{%- else -%}

  <div class="datajs--{{ section.id | default: product.id }}"{{-' '-}}
    data-imgUrl="{{'no-image.jpg' | asset_img_url: 'master' | replace: 'no-image.jpg', 'kiti'}}"{{-' '-}}
    data-imgspos="{{imgsPos|join:','}}"{{-' '-}}
    data-imgspos360="{{pos360|join:','}}"{{-' '-}}
    data-vrimgpos="{% if vrimgpos %}{{vrimgpos}}{% else %}{{imgsPos0}}{% endif %}"{{-' '-}}
    data-curpos="[{{imgsPos0}},{{imgsPos1}}]"{{-' '-}}
    data-df-variant="{{product.has_only_default_variant|json}}"></div>
    {%- assign video5_visible = product.media | where: 'media_type', 'video' | first -%}
    {%- assign external_video_visible = product.media | where: 'media_type', 'external_video' | first -%}
    {%- assign model_visible = product.media | where: 'media_type', 'model' | first -%}
  <div class="datasettings--{{ section.id | default: product.id }}" data-use-maxheight="{{settings.use_maxheight}}"{{-' '-}}
    data-use-qty="{{settings.show_quantity_selector}}"{{-' '-}}
    data-layout-section="{{section.settings.layout|default: '1'}}"{{-' '-}}
    data-width-section="{%-if settings.product_width_content and settings.product_width_section == 'w-100' or settings.product_width_section == 'container' -%}true{%-else-%}false{%-endif-%}"{{-' '-}}
    data-use-thumb-vertical="{{settings.use_thumb_vertical}}"{{-' '-}}
    data-gallery="{{settings.gallery}}"{{-' '-}}
    data-swatch-style="{{settings.swatch_style}}"{{-' '-}}
    data-wide="{{settings.use_wide}}"{{-' '-}}
    data-stickyATC="{{settings.show_sticky_add}}"{{-' '-}}
    data-video5="{%-if video5_visible -%}true{%-else-%}false{%-endif-%}"{{-' '-}}
    data-external-video="{%-if external_video_visible -%}true{%-else-%}false{%-endif-%}"{{-' '-}}
    data-model="{%-if model_visible -%}true{%-else-%}false{%-endif-%}"></div>

  <div class="lazyload lazypreload" data-include="{{product.url}}?view=sizeGuide"></div>
  {%- if settings.show_sticky_add and template.suffix != 'mix-a-match' -%}
  <div class="lazyload lazypreload" data-include="{{product.url}}?view=stickyATC"></div>
  {%- endif -%}
  {%- render 'tw-product-layout', imgsPos: imgsPos, imgsPos0: imgsPos0, imgsPos1: imgsPos1, checkOneImage_: checkOneImage_ -%}

  {%- if settings.img_type_prd_single == 'normal' -%}
  <style>.product-page .product-images .aspectRatio{padding-bottom: {{1|divided_by: product.featured_image.aspect_ratio | times: 100.00000000}}%;}</style>
  {%- endif -%}
  <script>var initialSlide = {{ imgPos | minus: imgsPos0 }};</script>
  {%-unless product == empty-%}
    <script type="application/json" id="ProductJson-{{ section.id }}">
      {{- product | json -}}
    </script>
    <script type="application/json" id="CollectionsJson-{{ section.id }}">
      {{- product.collections | json -}}
    </script>
    <script type="application/json" id="VariantsJson-{{ section.id }}">
      {%- assign metadata = '' -%}
      {%- for variant in product.variants -%}
        {%- unless forloop.first -%}{%- assign metadata = metadata | append: ',' -%}{%- endunless -%}
        {%- assign metadata = metadata | append: '{"id":' | append: variant.id | append: ',' -%}
        {%- assign quantity = variant.inventory_quantity | plus: 0 -%}
        {%- assign policy = variant.inventory_policy -%}
        {%- assign threshold = variant.metafields.deposco['threshold'] | plus: 0 -%}
        {%- assign soldOut = variant.metafields.deposco['Sold Out'] | default: '' | downcase -%}
        {%- if soldOut != '' -%}
          {%- assign bisDate = soldOut | date: '%B %d %Y' -%}
        {%- else -%}
          {%- assign bisDate = '' -%}
        {%- endif -%}
        {%- assign metadata = metadata | append: '"quantity":' | append: quantity | append: ',' -%}
        {%- assign metadata = metadata | append: '"policy":"' | append: policy | append: '",' -%}
        {%- assign metadata = metadata | append: '"threshold":' | append: threshold | append: ',' -%}
        {%- assign metadata = metadata | append: '"soldOut":"' | append: soldOut | append: '",' -%}
        {%- assign metadata = metadata | append: '"bisDate":"' | append: bisDate | append: '",' -%}
        {%- if quantity > 0 -%}
          {%- if threshold > 0 and quantity < threshold -%}
            {%- assign metadata = metadata | append: '"state":"almost-gone"' | append: '}' -%}
          {%- else -%}
            {%- assign metadata = metadata | append: '"state":"available"' | append: '}' -%}
          {%- endif -%}
        {%- else -%}
          {%- if policy == 'continue' and soldOut contains 'sold out until' and bisDate != soldOut -%}
            {%- assign metadata = metadata | append: '"state":"pre-order"' | append: '}' -%}
          {%- else -%}
            {%- assign metadata = metadata | append: '"state":"sold-out"' | append: '}' -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {{- metadata | prepend: '[' | append: ']' -}}
    </script>
    <script type="application/json" id="ModelJson-{{ section.id }}">
      {{- product.media | where: 'media_type', 'model' | json -}}
    </script>
  {%-endunless-%}
{%- endif -%}
{% schema %}
  {
    "name": "Product Single Page",
    "settings": [
      {
        "type": "header",
        "content": "Content settings"
      },
      {
        "type":"checkbox",
        "id": "use_d_c_b",
        "label": "Dynamic checkout buttons",
        "default": true
      },
      {
        "type": "header",
        "content": "Personalizer"
      },
      {
        "type": "textarea",
        "id": "safe_personalizer_message_text",
        "label": "Personalizer Notice"
      },
      {
        "type": "header",
        "content": "Production Lead Time"
      },
      {
        "type": "text",
        "id": "lead_time_title",
        "label": "Title",
        "default": "Production Time"
      },
      {
        "type": "text",
        "id": "lead_time_description",
        "label": "Description",
        "default": "Production Time - Does not include shipping time."
      },
      {
        "type": "text",
        "id": "lead_time_default",
        "label": "Dropdown default option",
        "default": "Please choose one"
      }
    ],
    "blocks": [
      {
        "type": "lead_time_option",
        "name": "Lead time option",
        "settings": [
          {
            "type": "text",
            "id": "lead_time_label",
            "label": "Production time option label"
          },                        
          {
            "type": "number",
            "id": "lead_time_cost",
            "label": "Production time cost, in dollars",
            "info": "optional, leave blank if option has no cost associated"
          }
        ]
      }
    ]
  }
{% endschema %}