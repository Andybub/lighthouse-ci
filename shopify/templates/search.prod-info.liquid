{%- layout none -%}
{%- paginate search.results by 250 -%}
{%- capture productIds -%}
  [
    {%- for item in search.results -%}
      {%- assign txtSoldOut = '' -%}
      {%- assign variants = '' -%}
      {%- for variant in item.variants -%}
        {%- unless forloop.first -%}
          {%- assign txtSoldOut = txtSoldOut | append: ' # ' -%}
        {%- endunless -%}
        {%- assign variantMetafield = variant.metafields.deposco['Sold Out'] | downcase -%}
        {%- assign metaDate = variantMetafield | date: '%B %d %Y' -%}
        {%- if variantMetafield contains "sold out until" and metaDate != variantMetafield -%}
          {%- assign txtSoldOut = txtSoldOut | append: "Preorder: Available on " | append: metaDate -%}
        {%- else -%}
          {%- assign txtSoldOut = txtSoldOut | append: " " -%}
        {%- endif -%}

        {%- if forloop.first -%}{%- assign variants = variants | append: '[' -%}{%- endif -%}
        {%- assign variants = variants | append: '{' -%}
        {%- assign variants = variants | append: '"id":' | append: variant.id | append: ',' -%}
        {%- assign variants = variants | append: '"inventory_quantity":' | append: variant.inventory_quantity | append: ',' -%}
        {%- assign variants = variants | append: '"inventory_policy":"' | append: variant.inventory_policy | append: '",' -%}

        {%- assign threshold = variant.metafields.deposco['threshold'] -%}
        {%- if threshold != blank -%}
          {%- assign threshold = threshold | plus: 0 -%}
        {%- else -%}
          {%- assign threshold = "0" | plus: 0 -%}
        {%- endif -%}
        {%- assign variants = variants | append: '"threshold":' | append: threshold | append: ',' -%}

        {%- if variantMetafield contains "sold out until" and metaDate != variantMetafield -%}
          {%- assign sold_out = "Preorder: Available on " | append: metaDate -%}
        {%- else -%}
          {%- assign sold_out = "" -%}
        {%- endif -%}
        {%- assign variants = variants | append: '"sold_out":"' | append: sold_out | append: '"' -%}

        {%- assign variants = variants | append: '}' -%}
        {%- unless forloop.last -%}{%- assign variants = variants | append: ',' -%}{%- endunless -%}
        {%- if forloop.last -%}{%- assign variants = variants | append: ']' -%}{%- endif -%}

      {%- endfor -%}
      {%- assign currVariant = item.selected_or_first_available_variant -%}

      {%- assign collections = "" %}
      {%- for c in item.collections %}
        {%- unless forloop.last -%}{%- assign collections = collections | append: c.handle | append: "," %}{%- endunless -%}
        {%- if forloop.last -%}{%- assign collections = collections | append: c.handle %}{%- endif -%}
      {%- endfor %}

      ,{
        "title": {{- item.title | json -}},
        "id": {{- item.id -}},
        "personalized": {% if item.type == 'Personalized' %}true{% else %}false{% endif %},
        "size": {{ item.metafields.c_f.sizing | json }},
        "inventory_quantity": {{- currVariant.inventory_quantity | json -}},
        "inventory_policy": {{- currVariant.inventory_policy | json -}},
        "sold_out": {{- txtSoldOut | split: ' # ' | json -}},
        "variants": {{- variants -}},
        "images": {{- item.images | slice: 1, 3 | json -}},
        "tags": {{- item.tags | json -}},
        "collections": {{- collections | split: "," | json -}}
      }
    {%- endfor -%}
  ]
{%- endcapture -%}
{{- productIds | remove_first: "," | strip_newlines -}}
{%- endpaginate -%}